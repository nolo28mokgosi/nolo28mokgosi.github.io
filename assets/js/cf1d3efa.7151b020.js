"use strict";(self.webpackChunknolo_28_mokgosi=self.webpackChunknolo_28_mokgosi||[]).push([[3734],{3905:function(e,n,t){t.d(n,{Zo:function(){return s},kt:function(){return f}});var i=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,i,r=function(e,n){if(null==e)return{};var t,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=i.createContext({}),u=function(e){var n=i.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},s=function(e){var n=u(e.components);return i.createElement(l.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},d=i.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),d=u(t),f=r,k=d["".concat(l,".").concat(f)]||d[f]||p[f]||a;return t?i.createElement(k,o(o({ref:n},s),{},{components:t})):i.createElement(k,o({ref:n},s))}));function f(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,o=new Array(a);o[0]=d;var c={};for(var l in n)hasOwnProperty.call(n,l)&&(c[l]=n[l]);c.originalType=e,c.mdxType="string"==typeof e?e:r,o[1]=c;for(var u=2;u<a;u++)o[u]=t[u];return i.createElement.apply(null,o)}return i.createElement.apply(null,t)}d.displayName="MDXCreateElement"},3166:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return c},contentTitle:function(){return l},metadata:function(){return u},toc:function(){return s},default:function(){return d}});var i=t(7462),r=t(3366),a=(t(7294),t(3905)),o=["components"],c={slug:"jwttokenvalidationonazurefunction",sidebar_label:"Firebase Token Validation in Azure",sidebar_position:1},l="Firebase Token Validation in Azure",u={unversionedId:"engineering/azurefunction-firebase-auth",id:"engineering/azurefunction-firebase-auth",isDocsHomePage:!1,title:"Firebase Token Validation in Azure",description:"This note documents a case where Firebase is used as Auth Server and Azure Function as the backend of the mobile application.",source:"@site/docs/engineering/azurefunction-firebase-auth.md",sourceDirName:"engineering",slug:"/engineering/jwttokenvalidationonazurefunction",permalink:"/docs/engineering/jwttokenvalidationonazurefunction",tags:[],version:"current",sidebarPosition:1,frontMatter:{slug:"jwttokenvalidationonazurefunction",sidebar_label:"Firebase Token Validation in Azure",sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"DI on function",permalink:"/docs/engineering/dependencyinjectiononfunctions"}},s=[{value:"React Native Setup",id:"react-native-setup",children:[],level:2},{value:"Authenticating in Azure function",id:"authenticating-in-azure-function",children:[{value:"Generating Key",id:"generating-key",children:[],level:3},{value:"Setup in Azure Function",id:"setup-in-azure-function",children:[],level:3},{value:"Dependency Injection",id:"dependency-injection",children:[],level:3},{value:"Verify Token",id:"verify-token",children:[],level:3}],level:2},{value:"Conclusion",id:"conclusion",children:[],level:2},{value:"Reference",id:"reference",children:[],level:2}],p={toc:s};function d(e){var n=e.components,t=(0,r.Z)(e,o);return(0,a.kt)("wrapper",(0,i.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"firebase-token-validation-in-azure"},"Firebase Token Validation in Azure"),(0,a.kt)("p",null,"This note documents a case where Firebase is used as Auth Server and Azure Function as the backend of the mobile application. "),(0,a.kt)("h2",{id:"react-native-setup"},"React Native Setup"),(0,a.kt)("p",null,"I followed ",(0,a.kt)("a",{parentName:"p",href:"https://www.freecodecamp.org/news/react-native-firebase-tutorial/"},"freecodecamp")," blog post for registration and login. It's quick and simple to setup."),(0,a.kt)("p",null,"Successful login will return a JWT token which can be used for secure communication with the backend."),(0,a.kt)("h2",{id:"authenticating-in-azure-function"},"Authenticating in Azure function"),(0,a.kt)("p",null,"To use firebase in .Net you have to install Firebase Admin .Net SDK.\nSDK enables access to firebase in .Net. The SDK provides custom authentication support at the moment. More details on reference point #2"),(0,a.kt)("p",null,"SETUP\nInstall FirebaseAdmin package from Nuget"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ dotnet add package FirebaseAdmin --version $VERSION\n")),(0,a.kt)("p",null,"According to #3, to authenticate service account and authorise it to Firebase services we need a private key."),(0,a.kt)("h3",{id:"generating-key"},"Generating Key"),(0,a.kt)("p",null,"If you don\u2019t have a firebase project go to firebase.google.com to create one. Once created, follow below steps to generate a key"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Log in to firebase console, open Settings, then go to Service Accounts"),(0,a.kt)("li",{parentName:"ul"},"Click \u201cGenerate New Private Key\u201d"),(0,a.kt)("li",{parentName:"ul"},"Store the JSON file containing the Key in a secure place..")),(0,a.kt)("h3",{id:"setup-in-azure-function"},"Setup in Azure Function"),(0,a.kt)("p",null,"To setup environment variables you can follow steps on ",(0,a.kt)("a",{parentName:"p",href:"https://firebase.google.com/docs/admin/setup/#windows"},"google document"),". I implemented it differently"),(0,a.kt)("h3",{id:"dependency-injection"},"Dependency Injection"),(0,a.kt)("p",null,"On my function code, local.settigns.json file, I added a global variable GOOGLE_APPLICATION_CREDENTIALS_STRING and assigned private key to it as illustrated below."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"\"GOOGLE_APPLICATION_CREDENTIALS_STRING\": \"{ 'type': 'service_account','project_id': \u2026}\u201d\n")),(0,a.kt)("p",null,"I then created a startup class where I startup firebase app using confit mentioned above"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'[assembly: FunctionsStartup(typeof(MyNameSpace.Startup))]\nnamespace MyNameSpace\n{\n    public class Startup : FunctionsStartup\n    {\n        public override void Configure(IFunctionsHostBuilder builder)\n        {\n            try\n            {\n                builder.Services.AddSingleton<ITokenValidator,TokenValidator>();\n\n                string json = Environment.GetEnvironmentVariable("GOOGLE_APPLICATION_CREDENTIALS_STRING");\n                if (json == null)\n                {\n                    throw new Exception(\n                        "GOOGLE_APPLICATION_CREDENTIALS_STRING environment variable with JSON is not set");\n                }\n\n                FirebaseApp.Create(new AppOptions()\n                {\n                    Credential = GoogleCredential.FromJson(json),\n                });\n\n                builder.Services.AddSingleton<ITokenValidator>((s) =>\n                {\n                    return new TokenValidator();\n                });\n            }\n            catch(Exception ex)\n            {\n                throw new Exception($"Failed to start the host.{ex}");\n            }\n        }\n    }\n}\n')),(0,a.kt)("h3",{id:"verify-token"},"Verify Token"),(0,a.kt)("p",null,"This section covers 2 points"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Creating of TokenValidator Class"),(0,a.kt)("li",{parentName:"ul"},"Validating Token at Azure function")),(0,a.kt)("p",null,"I creates a class Token Validator which is used at function level"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'namespace MyNameSpace\n{\n    public class TokenValidator : ITokenValidator\n    {\n        public async Task<string> ValidateAccessToken(string token)\n        {\n            if (string.IsNullOrEmpty(token))\n                throw new Exception("Token not set");\n\n            if (!token.Contains("Bearer"))\n            {\n                throw new Exception("Invalid token");\n            }\n\n            var accessToken = token.Substring("Bearer ".Length);\n\n            FirebaseToken decodedToken = await FirebaseAuth.DefaultInstance\n                .VerifyIdTokenAsync(accessToken);\n            return  decodedToken.Uid;\n        }\n    }\n}\n')),(0,a.kt)("p",null,"On the function, I used below code to validate the token"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'public  class GetFeedById\n{\n    private readonly ITokenValidator _tokenValidator;\n\n    public GetFeedById(ITokenValidator tokenValidator)\n    {\n        _tokenValidator = tokenValidator;\n    }\n\n    [FunctionName("GetFeedById")]\n    public  async Task<IActionResult> Run(\n        [HttpTrigger(AuthorizationLevel.Function, "get", "post", Route = null)] HttpRequest req,\n        ILogger log)\n    {\n        string token = req.Headers["Authorization"];\n        string userId = await _tokenValidator.ValidateAccessToken(token);\n        \n        ....\n    }\n}\n')),(0,a.kt)("h2",{id:"conclusion"},"Conclusion"),(0,a.kt)("p",null,"Other useful documentation includes"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://blog.markvincze.com/secure-an-asp-net-core-api-with-firebase/"},"Securing azure function")," by Mark"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://damienbod.com/2020/09/24/securing-azure-functions-using-azure-ad-jwt-bearer-token-authentication-for-user-access-tokens/"},"Securing azure function")," by Damien"),(0,a.kt)("li",{parentName:"ul"},"Jacob documented a nice piece on basics of ",(0,a.kt)("a",{parentName:"li",href:"https://medium.com/@jwngr/demystifying-firebase-auth-tokens-e0c533ed330c"},"Firebase Auth Tokens"))),(0,a.kt)("h2",{id:"reference"},"Reference"),(0,a.kt)("p",null,"#1 - ",(0,a.kt)("a",{parentName:"p",href:"https://www.freecodecamp.org/news/react-native-firebase-tutorial/"},"https://www.freecodecamp.org/news/react-native-firebase-tutorial/")),(0,a.kt)("p",null,"#2 - ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/Firebase/firebase-admin-dotnet"},"https://github.com/Firebase/firebase-admin-dotnet")),(0,a.kt)("p",null,"#3 - ",(0,a.kt)("a",{parentName:"p",href:"https://firebase.google.com/docs/admin/setup/#windows"},"https://firebase.google.com/docs/admin/setup/#windows")),(0,a.kt)("p",null,"#4 - ",(0,a.kt)("a",{parentName:"p",href:"https://firebase.google.com/docs/auth/admin/verify-id-tokens#c"},"https://firebase.google.com/docs/auth/admin/verify-id-tokens#c")))}d.isMDXComponent=!0}}]);